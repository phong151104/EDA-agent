catalog: lakehouse
schema: lh_vnfilm_v2
table_name: notify_sms
domain: vnfilm_ticketing

table_type: fact_log
business_name: "Log gửi SMS cho đơn hàng (notify_sms)"
grain: "1 dòng = 1 sự kiện gửi SMS (liên quan order hoặc order_refund nếu có)"

description: >
  Bảng log lưu lại các SMS được gửi từ hệ thống liên quan đến đơn hàng hoặc giao dịch hoàn tiền.
  Bao gồm loại SMS, nội dung, trạng thái, response từ SMS gateway, người gửi/nhận và timestamp tạo/cập nhật.
  Dùng để phân tích tần suất gửi SMS, lỗi khi gửi và tracing theo order hoặc receiver_hash.

tags:
  - fact
  - log
  - notification
  - sms
  - vnfilm

primary_key:
  - id

foreign_keys:
  - column: order_id
    references_table: "lakehouse.lh_vnfilm_v2.orders"
    references_column: "id"
    relation: "one_to_one"
    description: "SMS thuộc về đơn hàng nào (nếu có)."

  - column: order_refund_id
    references_table: "lakehouse.lh_vnfilm_v2.order_refund"
    references_column: "id"
    relation: "one_to_one"
    description: "SMS liên quan tới giao dịch hoàn tiền nào (nếu có)."

  - column: original_id
    references_table: "lakehouse.lh_vnfilm_v2.notify_sms"
    references_column: "id"
    relation: "self_reference"
    description: "Tham chiếu tới notify_sms gốc trong trường hợp retry."

time_columns:
  - created_date
  - modified_date

recommended_filters:
  - "created_date cho phân tích theo thời gian gửi SMS"
  - "order_id để truy vấn theo đơn hàng cụ thể"
  - "type để phân tích theo loại SMS"
  - "status để lọc SMS gửi thành công/thất bại"
  - "receiver_hash để phân tích theo nhóm người nhận ẩn danh"

concepts:
  - name: sms_notification
    synonyms: ["sms", "tin nhắn", "notification", "otp", "text message"]

  - name: order
    synonyms: ["đơn hàng", "order", "transaction"]

  - name: refund
    synonyms: ["refund", "hoàn tiền"]

columns:
  id:
    data_type: bigint
    business_name: "ID bản ghi SMS log"
    description: "Khóa chính của notify_sms."
    semantics: [id, primary, log]
    pii: false

  order_id:
    data_type: bigint
    business_name: "ID đơn hàng"
    description: "SMS thuộc về đơn hàng nào."
    semantics: [id, order]
    pii: false

  order_refund_id:
    data_type: bigint
    business_name: "ID refund"
    description: "SMS liên quan tới giao dịch hoàn tiền."
    semantics: [id, refund]
    pii: false

  original_id:
    data_type: bigint
    business_name: "ID SMS gốc"
    description: "Tham chiếu tới notify_sms ban đầu trong trường hợp retry."
    semantics: [id, reference]

  type:
    data_type: varchar
    business_name: "Loại SMS"
    description: "Loại thông báo SMS (ví dụ: CONFIRMATION, REFUND, OTP, ERROR...)."
    semantics: [category, notification, type]

  content:
    data_type: varchar
    business_name: "Nội dung SMS"
    description: "Content dạng text/raw của SMS."
    semantics: [text, message, sms]

  status:
    data_type: varchar
    business_name: "Trạng thái gửi SMS"
    description: "Trạng thái gửi: SUCCESS / FAIL / PENDING."
    semantics: [status, notification]

  server_response_data:
    data_type: varchar
    business_name: "Response từ SMS gateway"
    description: "Payload/phản hồi từ hệ thống SMS gateway."
    semantics: [text, server_response]

  created_date:
    data_type: timestamp(6)
    business_name: "Thời điểm tạo"
    description: "Thời điểm hệ thống ghi nhận log SMS."
    semantics: [date, created_time]

  modified_date:
    data_type: timestamp(6)
    business_name: "Thời điểm cập nhật"
    description: "Thời điểm cập nhật bản ghi."
    semantics: [date, modified_time]

  modified_by:
    data_type: varchar
    business_name: "Người cập nhật"
    description: "User/service cập nhật bản ghi."
    semantics: [user_identity, modifier]
    pii: true
    sensitive: true

  created_by:
    data_type: varchar
    business_name: "Người tạo"
    description: "User/service tạo bản ghi log."
    semantics: [user_identity, creator]
    pii: true
    sensitive: true

  created_by_hash:
    data_type: varchar
    business_name: "Hash người tạo"
    description: "Hash ẩn danh của created_by."
    semantics: [user_identity, creator, hash]
    pii: false
    sensitive: true

  receiver:
    data_type: varchar
    business_name: "Số điện thoại người nhận"
    description: "Số điện thoại SMS được gửi tới."
    semantics: [phone, receiver]
    pii: true
    sensitive: true

  receiver_hash:
    data_type: varchar
    business_name: "Hash người nhận"
    description: "Hash ẩn danh số điện thoại người nhận."
    semantics: [phone, receiver, hash]
    pii: false
    sensitive: true

guardrails:
  sql:
    read_only: true
    require_limit: true
    default_limit: 200
    forbid_select_star: true
    preferred_time_filter: "created_date"
    allowed_time_columns:
      - created_date
      - modified_date
    forbidden_columns:
      - receiver
      - created_by
      - modified_by

sample_questions:
  - "Có bao nhiêu SMS gửi thất bại trong 24h qua?"
  - "Tỉ lệ gửi SMS thành công theo từng loại type?"
  - "Những đơn hàng nào đã được gửi SMS xác nhận?"
  - "Số lượng SMS theo receiver_hash trong 7 ngày gần nhất?"
  - "Bao nhiêu SMS là bản retry (original_id không null)?"

sample_queries:
  - description: "Thống kê số SMS theo loại"
    sql: |
      SELECT
        type,
        COUNT(*) AS total_sms
      FROM lakehouse.lh_vnfilm_v2.notify_sms
      GROUP BY type
      ORDER BY total_sms DESC

  - description: "Lịch sử SMS của đơn hàng 1"
    sql: |
      SELECT
        id,
        type,
        content,
        status,
        created_date
      FROM lakehouse.lh_vnfilm_v2.notify_sms
      WHERE order_id = 1
      ORDER BY created_date DESC
      LIMIT 200
