catalog: lakehouse
schema: cdp_mart
table_name: cdp_camp_conversion_stage
domain: vnfilm_ticketing

table_type: fact_aggregate
business_name: "Bảng tổng hợp funnel chuyển đổi theo stage cho campaign (cdp_camp_conversion_stage)"
grain: "1 dòng = 1 campaign tại 1 thời điểm tổng hợp (created_at)"

description: >
  Bảng fact aggregate lưu số lượng khách hàng và tỉ lệ chuyển đổi theo từng stage
  trong funnel của mỗi campaign. Thường được join với dim_campaign qua campaign_id
  để phân tích hiệu quả campaign theo từng giai đoạn: stage_1 → stage_5.

tags:
  - fact
  - aggregate
  - funnel
  - conversion
  - campaign
  - cdp
  - analytics

primary_key:
  - campaign_id
  - created_at

foreign_keys:
  - column: campaign_id
    references_table: "lakehouse.cdp_mart.dim_campaign"
    references_column: "campaign_id"
    relation: "one_to_one"
    description: "Join sang dim_campaign để lấy thông tin mô tả campaign."

time_columns:
  - created_at

recommended_filters:
  - "created_at cho phân tích funnel theo thời gian snapshot"
  - "campaign_id hoặc campaign_code (sau khi join dim_campaign) để lọc từng campaign"
  - "bank_code / service_code (sau khi join dim_campaign) cho phân tích theo ngân hàng/dịch vụ"

concepts:
  - name: conversion_funnel
    synonyms: ["funnel", "chuyển đổi", "conversion", "giai đoạn", "stage"]

  - name: campaign
    synonyms: ["chiến dịch", "campaign", "marketing campaign"]

columns:
  campaign_id:
    data_type: varchar
    business_name: "ID chiến dịch"
    description: "Mã campaign, join sang dim_campaign.campaign_id."
    semantics: [id, campaign]
    pii: false

  created_at:
    data_type: timestamp(6)
    business_name: "Thời điểm tổng hợp"
    description: "Thời điểm snapshot số liệu funnel cho campaign."
    semantics: [date, snapshot_time]

  num_cus_stage_1:
    data_type: integer
    business_name: "Số KH ở stage 1"
    description: "Số lượng khách hàng ở giai đoạn 1 của funnel."
    semantics: [count, customer, stage_1]

  num_cus_stage_2:
    data_type: integer
    business_name: "Số KH ở stage 2"
    description: "Số lượng khách hàng ở giai đoạn 2 của funnel."
    semantics: [count, customer, stage_2]

  num_cus_stage_3:
    data_type: integer
    business_name: "Số KH ở stage 3"
    description: "Số lượng khách hàng ở giai đoạn 3 của funnel."
    semantics: [count, customer, stage_3]

  num_cus_stage_4:
    data_type: integer
    business_name: "Số KH ở stage 4"
    description: "Số lượng khách hàng ở giai đoạn 4 của funnel."
    semantics: [count, customer, stage_4]

  num_cus_stage_5:
    data_type: integer
    business_name: "Số KH ở stage 5"
    description: "Số lượng khách hàng ở giai đoạn 5 của funnel (stage cuối)."
    semantics: [count, customer, stage_5]

  conversion_rate_stage_1:
    data_type: double
    business_name: "Tỉ lệ chuyển đổi stage 1"
    description: "Tỉ lệ chuyển đổi đến stage 1 (thường so với tổng KH target hoặc stage trước)."
    semantics: [ratio, conversion, stage_1]

  conversion_rate_stage_2:
    data_type: double
    business_name: "Tỉ lệ chuyển đổi stage 2"
    description: "Tỉ lệ chuyển đổi đến stage 2."
    semantics: [ratio, conversion, stage_2]

  conversion_rate_stage_3:
    data_type: double
    business_name: "Tỉ lệ chuyển đổi stage 3"
    description: "Tỉ lệ chuyển đổi đến stage 3."
    semantics: [ratio, conversion, stage_3]

  conversion_rate_stage_4:
    data_type: double
    business_name: "Tỉ lệ chuyển đổi stage 4"
    description: "Tỉ lệ chuyển đổi đến stage 4."
    semantics: [ratio, conversion, stage_4]

  conversion_rate_stage_5:
    data_type: double
    business_name: "Tỉ lệ chuyển đổi stage 5"
    description: "Tỉ lệ chuyển đổi đến stage 5 (stage cuối của funnel)."
    semantics: [ratio, conversion, stage_5]

guardrails:
  sql:
    read_only: true
    require_limit: true
    default_limit: 200
    forbid_select_star: false
    preferred_time_filter: "created_at"
    allowed_time_columns:
      - created_at
    forbidden_columns: []

sample_questions:
  - "Tỉ lệ chuyển đổi qua từng stage của campaign X là bao nhiêu?"
  - "So sánh số lượng khách hàng ở từng stage giữa các campaign trong tuần vừa rồi?"
  - "Stage nào trong funnel của campaign có tỉ lệ rớt lớn nhất?"
  - "Xu hướng conversion rate stage_5 theo thời gian của một campaign?"

sample_queries:
  - description: "Funnel conversion rate theo từng stage cho một campaign"
    sql: |
      SELECT
        campaign_id,
        created_at,
        conversion_rate_stage_1,
        conversion_rate_stage_2,
        conversion_rate_stage_3,
        conversion_rate_stage_4,
        conversion_rate_stage_5
      FROM lakehouse.cdp_mart.cdp_camp_conversion_stage
      WHERE campaign_id = :campaign_id
      ORDER BY created_at DESC
      LIMIT 100;

  - description: "So sánh số khách hàng ở từng stage của các campaign tại snapshot mới nhất"
    sql: |
      WITH latest AS (
        SELECT
          campaign_id,
          MAX(created_at) AS max_created_at
        FROM lakehouse.cdp_mart.cdp_camp_conversion_stage
        GROUP BY campaign_id
      )
      SELECT
        s.campaign_id,
        s.num_cus_stage_1,
        s.num_cus_stage_2,
        s.num_cus_stage_3,
        s.num_cus_stage_4,
        s.num_cus_stage_5
      FROM lakehouse.cdp_mart.cdp_camp_conversion_stage s
      JOIN latest l
        ON s.campaign_id = l.campaign_id
       AND s.created_at = l.max_created_at
      ORDER BY s.campaign_id;
