catalog: lakehouse
schema: lh_vnfilm_v2
table_name: sub_campaign
domain: vnfilm_ticketing

table_type: dimension
business_name: "Bảng cấu hình chiến dịch con (Sub-Campaign)"
grain: "1 dòng = 1 cấu hình chi tiết cho một chiến dịch khuyến mãi."

description: >
  Bảng sub_campaign lưu trữ các cấu hình chi tiết (Rules) của một chiến dịch khuyến mãi.
  Bao gồm các quy tắc về thời gian đặt vé, thời gian suất chiếu, giá vé/combo áp dụng (cho cả Vendor và VNPAY),
  số lượng giới hạn (Quota) và các ngày loại trừ (Exclude Dates).

tags:
  - dim
  - campaign
  - promotion_rules
  - pricing_config
  - vnfilm

primary_key:
  - id

foreign_keys:
  - column: campaign_id
    references_table: "lakehouse.lh_vnfilm_v2.campaign"
    references_column: "id"
    relation: "many_to_one"
    description: "Join sang bảng campaign để lấy thông tin chiến dịch cha."

  - column: vendor_id
    references_table: "lakehouse.lh_vnfilm_v2.vendor"
    references_column: "id"
    relation: "many_to_one"
    description: "Join sang bảng vendor."

time_columns:
  - booking_date_from
  - booking_date_to
  - session_date_from
  - session_date_to
  - created_date
  - modified_date

recommended_filters:
  - "status = 'active' để lấy các chiến dịch đang chạy"
  - "campaign_type để lọc loại khuyến mãi (groupSale/normal)"
  - "booking_date_to >= current_date để lọc các chiến dịch chưa hết hạn"

concepts:
  - name: campaign_rule
    synonyms: ["luật khuyến mãi", "thể lệ", "config"]
  - name: quota
    synonyms: ["giới hạn", "số lượng", "limit"]

columns:
  id:
    data_type: bigint
    business_name: "ID bản ghi"
    description: "Mã định danh duy nhất của sub-campaign."
    semantics: [id, primary]
    pii: false

  campaign_id:
    data_type: bigint
    business_name: "ID Chiến dịch cha"
    description: "Mã định danh chiến dịch tổng (Campaign)."
    semantics: [id, campaign, foreign_key]

  name:
    data_type: varchar
    business_name: "Tên chiến dịch con"
    description: "Tên hiển thị của cấu hình khuyến mãi."
    semantics: [name, campaign]

  description:
    data_type: varchar
    business_name: "Mô tả"
    description: "Mô tả chi tiết nội dung khuyến mãi."
    semantics: [text, description]

  vendor_campaign_id:
    data_type: varchar
    business_name: "Mã KM (Vendor)"
    description: "Mã định danh chiến dịch phía hệ thống Vendor (Mapping)."
    semantics: [code, vendor, external_id]

  vendor_id:
    data_type: bigint
    business_name: "ID Vendor"
    description: "Mã định danh đối tác áp dụng."
    semantics: [id, vendor]

  priority:
    data_type: integer
    business_name: "Độ ưu tiên"
    description: "Thứ tự ưu tiên áp dụng (số nhỏ ưu tiên cao hoặc ngược lại tùy logic)."
    semantics: [metric, priority]

  # --- QUOTA & LIMITS ---
  seat_quantity:
    data_type: integer
    business_name: "Tổng Quota Ghế"
    description: "Tổng số lượng ghế được áp dụng khuyến mãi này."
    semantics: [metric, quota, seat]

  combo_quantity:
    data_type: integer
    business_name: "Tổng Quota Combo"
    description: "Tổng số lượng combo được áp dụng khuyến mãi này."
    semantics: [metric, quota, concession]

  booking_seat_limit:
    data_type: integer
    business_name: "GH Ghế/Đơn"
    description: "Số ghế tối đa được hưởng KM trên 1 đơn hàng (-1 là không giới hạn)."
    semantics: [metric, limit, seat]

  booking_concession_limit:
    data_type: integer
    business_name: "GH Combo/Đơn"
    description: "Số combo tối đa được hưởng KM trên 1 đơn hàng."
    semantics: [metric, limit, concession]

  limit_by:
    data_type: varchar
    business_name: "Loại giới hạn"
    description: "Giới hạn theo tiêu chí gì (user, device, day...)."
    semantics: [category, limit_type]

  limit_quantity:
    data_type: integer
    business_name: "Số lượng giới hạn"
    description: "Số lượng giới hạn cụ thể theo tiêu chí limit_by."
    semantics: [metric, limit]

  limit_unit:
    data_type: varchar
    business_name: "Đơn vị giới hạn"
    description: "Đơn vị tính giới hạn (lần, cái...)."
    semantics: [text, unit]

  # --- TIME CONFIG ---
  booking_date_from:
    data_type: timestamp(6)
    business_name: "Bắt đầu đặt vé"
    description: "Thời gian bắt đầu cho phép đặt vé."
    semantics: [date, start_time, booking]

  booking_date_to:
    data_type: timestamp(6)
    business_name: "Kết thúc đặt vé"
    description: "Thời gian kết thúc cho phép đặt vé."
    semantics: [date, end_time, booking]

  session_date_from:
    data_type: timestamp(6)
    business_name: "Bắt đầu suất chiếu"
    description: "Áp dụng cho các suất chiếu từ thời điểm này."
    semantics: [date, start_time, session]

  session_date_to:
    data_type: timestamp(6)
    business_name: "Kết thúc suất chiếu"
    description: "Áp dụng cho các suất chiếu đến thời điểm này."
    semantics: [date, end_time, session]

  booking_exclude_date:
    data_type: varchar
    business_name: "Ngày loại trừ (Booking)"
    description: "Danh sách ngày không áp dụng đặt vé (JSON Array)."
    semantics: [data, json, exclude_date]

  session_exclude_date:
    data_type: varchar
    business_name: "Ngày loại trừ (Suất chiếu)"
    description: "Danh sách ngày suất chiếu không áp dụng (JSON Array)."
    semantics: [data, json, exclude_date]

  # --- PRICING CONFIG ---
  vendor_seat_price:
    data_type: decimal(38,18)
    business_name: "Giá ghế đối soát"
    description: "Giá ghế dùng để đối soát với Vendor."
    semantics: [amount, currency, cost]
    unit: vnd

  vendor_seat_apply_from:
    data_type: decimal(38,18)
    business_name: "Giá ghế gốc (Min)"
    description: "Áp dụng cho ghế có giá gốc từ mức này."
    semantics: [amount, currency, condition]
    unit: vnd

  vendor_seat_apply_to:
    data_type: decimal(38,18)
    business_name: "Giá ghế gốc (Max)"
    description: "Áp dụng cho ghế có giá gốc đến mức này."
    semantics: [amount, currency, condition]
    unit: vnd

  vendor_combo_price:
    data_type: decimal(38,18)
    business_name: "Giá combo đối soát"
    description: "Giá combo dùng để đối soát với Vendor."
    semantics: [amount, currency, cost]
    unit: vnd

  vnpay_seat_price:
    data_type: decimal(38,18)
    business_name: "Giá ghế bán (VNPAY)"
    description: "Giá vé ưu đãi bán cho khách hàng trên VNPAY."
    semantics: [amount, currency, price]
    unit: vnd

  vnpay_concession_price:
    data_type: decimal(38,18)
    business_name: "Giá combo bán (VNPAY)"
    description: "Giá combo ưu đãi bán cho khách hàng trên VNPAY."
    semantics: [amount, currency, price]
    unit: vnd

  # --- SYSTEM SETTINGS ---
  campaign_checkin_step:
    data_type: varchar
    business_name: "Bước kiểm tra"
    description: "Giai đoạn kiểm tra điều kiện (getSeat, payment...)."
    semantics: [category, system_logic]

  campaign_type:
    data_type: varchar
    business_name: "Loại chiến dịch"
    description: "Phân loại (normal, groupSale, promotion...)."
    semantics: [category, campaign_type]

  is_auto_apply_discount:
    data_type: boolean
    business_name: "Tự động áp dụng"
    description: "Cờ đánh dấu có tự động áp dụng ưu đãi không."
    semantics: [flag, automation]

  discount_note:
    data_type: varchar
    business_name: "Ghi chú giảm giá"
    description: "Ghi chú thêm về giảm giá."
    semantics: [text, note]

  status:
    data_type: varchar
    business_name: "Trạng thái"
    description: "Trạng thái hoạt động (active, inactive)."
    semantics: [status, active_state]

  mode:
    data_type: varchar
    business_name: "Chế độ"
    description: "Chế độ chạy (live: Public, pilot: Thử nghiệm)."
    semantics: [category, system_mode]

  created_date:
    data_type: timestamp(6)
    business_name: "Ngày tạo"
    description: "Thời điểm tạo cấu hình."
    semantics: [date, created_time]

  created_by:
    data_type: varchar
    business_name: "Người tạo"
    description: "User tạo bản ghi."
    semantics: [user_identity, creator, raw]
    pii: true
    sensitive: true

  created_by_hash:
    data_type: varchar
    business_name: "Người tạo (Hash)"
    description: "Mã hash người tạo."
    semantics: [user_identity, creator, hash]
    pii: false

  modified_date:
    data_type: timestamp(6)
    business_name: "Ngày cập nhật"
    description: "Thời điểm cập nhật cuối cùng."
    semantics: [date, modified_time]

  modified_by:
    data_type: varchar
    business_name: "Người cập nhật"
    description: "User cập nhật bản ghi."
    semantics: [user_identity, modifier]

guardrails:
  sql:
    read_only: true
    require_limit: true
    default_limit: 100
    forbid_select_star: true
    preferred_time_filter: "created_date"
    forbidden_columns:
      - created_by

sample_questions:
  - "Các chiến dịch GroupSale nào đang chạy (active)?"
  - "Chiến dịch nào có giá bán vé (vnpay_seat_price) là 79k?"
  - "Danh sách các ngày bị loại trừ (exclude dates) của chiến dịch Lotte?"

sample_queries:
  - description: "Lấy danh sách các Sub-Campaign đang hoạt động và còn hạn booking"
    sql: |
      SELECT
        id,
        name,
        vnpay_seat_price,
        booking_date_to,
        vendor_campaign_id
      FROM lakehouse.lh_vnfilm_v2.sub_campaign
      WHERE status = 'active'
        AND booking_date_to >= current_date
      ORDER BY booking_date_to ASC