catalog: lakehouse
schema: lh_vnfilm_v2
table_name: pre_order_concession
domain: vnfilm_ticketing

table_type: fact_transaction
business_name: "Bảng chi tiết Combo/Bắp nước đặt trước (Pre-Order)"
grain: "1 dòng = 1 loại combo trong giỏ hàng đặt trước."

description: >
  Bảng pre_order_concession lưu trữ chi tiết các món bắp nước (Concession/Combo) mà khách hàng đã chọn 
  trong phiên giao dịch (gắn với pre_order_id).
  Bảng này chứa thông tin về số lượng, giá bán niêm yết tại thời điểm chọn, hình ảnh và các thông tin 
  khuyến mãi (Campaign/Promotion) áp dụng cho từng món.

tags:
  - fact
  - pre_order
  - concession
  - combo
  - shopping_cart
  - vnfilm

primary_key:
  - id

foreign_keys:
  - column: pre_order_id
    references_table: "lakehouse.lh_vnfilm_v2.pre_order"
    references_column: "id"
    relation: "many_to_one"
    description: "Join sang bảng pre_order để lấy thông tin phiên giao dịch."

  - column: campaign_id
    references_table: "lakehouse.lh_vnfilm_v2.campaign"
    references_column: "id"
    relation: "many_to_one"
    description: "Join sang bảng campaign (nếu có áp dụng)."

time_columns:
  - created_date

recommended_filters:
  - "vendor_concession_name để thống kê món được chọn nhiều nhất"
  - "campaign_code để xem hiệu quả khuyến mãi trên combo"
  - "created_date để trace log"

concepts:
  - name: concession
    synonyms: ["combo", "bắp nước", "food", "drink"]
  - name: quantity
    synonyms: ["số lượng", "qty"]

columns:
  id:
    data_type: bigint
    business_name: "ID bản ghi"
    description: "Mã định danh duy nhất của dòng combo đặt trước."
    semantics: [id, primary]
    pii: false

  pre_order_id:
    data_type: bigint
    business_name: "ID Pre-Order"
    description: "Mã định danh phiên giao dịch đặt trước."
    semantics: [id, pre_order, foreign_key]

  quantity:
    data_type: decimal(38,18)
    business_name: "Số lượng"
    description: "Số lượng combo khách hàng chọn."
    semantics: [metric, quantity]

  # --- VENDOR CONCESSION INFO ---
  vendor_concession_id:
    data_type: varchar
    business_name: "Mã Combo (Vendor)"
    description: "Mã định danh sản phẩm phía Vendor."
    semantics: [id, vendor, product]

  vendor_concession_type:
    data_type: varchar
    business_name: "Loại Combo"
    description: "Phân loại sản phẩm (VD: Combo, Alacarte...)."
    semantics: [category, product_type]

  vendor_concession_name:
    data_type: varchar
    business_name: "Tên Combo"
    description: "Tên hiển thị của sản phẩm."
    semantics: [name, product]

  vendor_concession_description:
    data_type: varchar
    business_name: "Mô tả Combo"
    description: "Thông tin chi tiết thành phần combo."
    semantics: [text, description]

  vendor_concession_image:
    data_type: varchar
    business_name: "Ảnh Combo"
    description: "Link hình ảnh sản phẩm."
    semantics: [url, image]

  vendor_additional_data:
    data_type: varchar
    business_name: "Dữ liệu bổ sung (Vendor)"
    description: "Metadata khác từ vendor."
    semantics: [text, metadata]

  # --- PRICING ---
  vendor_concession_price:
    data_type: decimal(38,18)
    business_name: "Giá Vendor"
    description: "Giá niêm yết của Vendor cho sản phẩm này."
    semantics: [amount, currency, price]
    unit: vnd

  vendor_discount_price:
    data_type: decimal(38,18)
    business_name: "Giảm giá Vendor (Gốc)"
    description: "Giá trị giảm giá gốc từ phía Vendor (nếu có)."
    semantics: [amount, currency, discount]
    unit: vnd

  vnpay_concession_price:
    data_type: decimal(38,18)
    business_name: "Giá VNPAY bán"
    description: "Giá bán hiển thị trên ứng dụng VNPAY."
    semantics: [amount, currency, price]
    unit: vnd

  # --- CAMPAIGN & PROMOTION ---
  campaign_id:
    data_type: bigint
    business_name: "ID Chiến dịch"
    description: "Mã chiến dịch khuyến mãi."
    semantics: [id, campaign]

  sub_campaign_id:
    data_type: bigint
    business_name: "ID Chiến dịch con"
    description: "Mã chiến dịch con."
    semantics: [id, campaign, sub]

  campaign_code:
    data_type: varchar
    business_name: "Mã Campaign"
    description: "Mã code chiến dịch."
    semantics: [code, campaign]

  campaign_type:
    data_type: varchar
    business_name: "Loại Campaign"
    description: "Loại hình chiến dịch."
    semantics: [category, campaign_type]

  campaign_vendor_discount:
    data_type: decimal(38,18)
    business_name: "KM Campaign (Vendor)"
    description: "Số tiền khuyến mãi theo campaign do Vendor chịu."
    semantics: [amount, currency, discount]
    unit: vnd

  campaign_vnpay_discount:
    data_type: decimal(38,18)
    business_name: "KM Campaign (VNPAY)"
    description: "Số tiền khuyến mãi theo campaign do VNPAY chịu."
    semantics: [amount, currency, discount]
    unit: vnd

  promotion_vendor_discount:
    data_type: decimal(38,18)
    business_name: "KM Promotion (Vendor)"
    description: "Số tiền giảm giá promotion do Vendor chịu."
    semantics: [amount, currency, discount]
    unit: vnd

  promotion_vnpay_discount:
    data_type: decimal(38,18)
    business_name: "KM Promotion (VNPAY)"
    description: "Số tiền giảm giá promotion do VNPAY chịu."
    semantics: [amount, currency, discount]
    unit: vnd

  promotion_vendor_amount:
    data_type: decimal(38,18)
    business_name: "Tổng Promo (Vendor)"
    description: "Tổng tiền Vendor tài trợ promotion cho item này."
    semantics: [amount, currency, promotion]
    unit: vnd

  promotion_vnpay_amount:
    data_type: decimal(38,18)
    business_name: "Tổng Promo (VNPAY)"
    description: "Tổng tiền VNPAY tài trợ promotion cho item này."
    semantics: [amount, currency, promotion]
    unit: vnd

  # --- SYSTEM ---
  created_date:
    data_type: timestamp(6)
    business_name: "Ngày tạo"
    description: "Thời điểm thêm combo vào giỏ."
    semantics: [date, created_time]

  created_by:
    data_type: varchar
    business_name: "Người tạo"
    description: "User hệ thống (raw)."
    semantics: [user_identity, creator, raw]
    pii: true
    sensitive: true

  created_by_hash:
    data_type: varchar
    business_name: "Người tạo (Hash)"
    description: "Mã hash người tạo."
    semantics: [user_identity, creator, hash]
    pii: false

guardrails:
  sql:
    read_only: true
    require_limit: true
    default_limit: 200
    forbid_select_star: true
    preferred_time_filter: "created_date"
    forbidden_columns:
      - created_by

sample_questions:
  - "Top 5 combo được thêm vào giỏ hàng nhiều nhất hôm nay?"
  - "Tỷ lệ combo có áp dụng khuyến mãi (campaign_code is not null)?"
  - "Giá trị trung bình của các combo được chọn?"

sample_queries:
  - description: "Thống kê top combo được quan tâm (Pre-order)"
    sql: |
      SELECT
        vendor_concession_name,
        SUM(quantity) as total_quantity_selected
      FROM lakehouse.lh_vnfilm_v2.pre_order_concession
      WHERE created_date >= date_trunc('day', current_date)
      GROUP BY 1
      ORDER BY 2 DESC
      LIMIT 10